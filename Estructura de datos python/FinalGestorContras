import re
import hashlib
import secrets
import string
from datetime import datetime

class GestorContrase√±as:
    def __init__(self):
        self.usuarios = []
        self.contrase√±as = []
        self.alertas = []
    
    def registrar_usuario(self, usuario, contrase√±a):
        """
        Registra un nuevo usuario con su contrase√±a
        """
        if usuario in self.usuarios:
            print(f" El usuario '{usuario}' ya existe.")
            return False
        
        if not self._verificar_fortaleza_contrase√±a(contrase√±a):
            print(" La contrase√±a no cumple con los requisitos de seguridad.")
            return False
        
        contrase√±a_hash = self._hash_contrase√±a(contrase√±a)
        
        self.usuarios.append(usuario)
        self.contrase√±as.append(contrase√±a_hash)
        
        print(f" Usuario '{usuario}' registrado exitosamente.")
        return True
    
    def _verificar_fortaleza_contrase√±a(self, contrase√±a):
        """
        Verifica la fortaleza de una contrase√±a
        """
        if len(contrase√±a) < 8:
            return False
        
        criterios = {
            'may√∫sculas': bool(re.search(r'[A-Z]', contrase√±a)),
            'min√∫sculas': bool(re.search(r'[a-z]', contrase√±a)),
            'n√∫meros': bool(re.search(r'\d', contrase√±a)),
            'caracteres_especiales': bool(re.search(r'[!@#$%^&*(),.?":{}|<>]', contrase√±a)),
            'sin_espacios': ' ' not in contrase√±a
        }
        
        criterios_cumplidos = sum(criterios.values())
        
        if criterios_cumplidos < 4:
            self._generar_alerta(f"Contrase√±a d√©bil detectada. Criterios cumplidos: {criterios_cumplidos}/5")
            return False
        
        return True
    
    def _hash_contrase√±a(self, contrase√±a):
        """
        Convierte la contrase√±a en un hash seguro
        """
        return hashlib.sha256(contrase√±a.encode()).hexdigest()
    
    def verificar_contrase√±a(self, usuario, contrase√±a):
        """
        Verifica si la contrase√±a coincide para un usuario
        """
        if usuario not in self.usuarios:
            print(" Usuario no encontrado.")
            return False
        
        indice = self.usuarios.index(usuario)
        contrase√±a_hash = self._hash_contrase√±a(contrase√±a)
        
        if self.contrase√±as[indice] == contrase√±a_hash:
            print(" Contrase√±a correcta.")
            return True
        else:
            print(" Contrase√±a incorrecta.")
            return False
    
    def _generar_alerta(self, mensaje):
        """
        Genera una alerta de seguridad
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        alerta = f"[{timestamp}] ALERTA: {mensaje}"
        self.alertas.append(alerta)
        print(f"  {alerta}")
    
    def generar_contrase√±a_segura(self, longitud=12):
        """
        Genera una contrase√±a segura autom√°ticamente
        """
        if longitud < 8:
            longitud = 8
        
        letras_mayusculas = string.ascii_uppercase
        letras_minusculas = string.ascii_lowercase
        digitos = string.digits
        caracteres_especiales = "!@#$%^&*()"
        
        contrase√±a = [
            secrets.choice(letras_mayusculas),
            secrets.choice(letras_minusculas),
            secrets.choice(digitos),
            secrets.choice(caracteres_especiales)
        ]
        
        todos_caracteres = letras_mayusculas + letras_minusculas + digitos + caracteres_especiales
        contrase√±a.extend(secrets.choice(todos_caracteres) for _ in range(longitud - 4))
        
        secrets.SystemRandom().shuffle(contrase√±a)
        
        contrase√±a_generada = ''.join(contrase√±a)
        print(f" Contrase√±a generada: {contrase√±a_generada}")
        return contrase√±a_generada
    
    def mostrar_usuarios(self):
        """
        Muestra todos los usuarios registrados (sin contrase√±as)
        """
        if not self.usuarios:
            print(" No hay usuarios registrados.")
            return
        
        print("\n Usuarios registrados:")
        for i, usuario in enumerate(self.usuarios, 1):
            print(f"  {i}. {usuario}")
    
    def mostrar_alertas(self):
        """
        Muestra todas las alertas generadas
        """
        if not self.alertas:
            print(" No hay alertas de seguridad.")
            return
        
        print("\n Alertas de seguridad:")
        for alerta in self.alertas:
            print(f"  ‚Ä¢ {alerta}")
    
    def evaluar_contrase√±a(self, contrase√±a):
        """
        Eval√∫a y muestra informaci√≥n detallada sobre la fortaleza de una contrase√±a
        """
        print(f"\nüîç Evaluando contrase√±a: {'*' * len(contrase√±a)}")
        
        puntuacion = 0
        criterios = {}
        
        if len(contrase√±a) >= 12:
            criterios['Longitud ‚â• 12 caracteres'] = True
            puntuacion += 2
        elif len(contrase√±a) >= 8:
            criterios['Longitud ‚â• 8 caracteres'] = True
            puntuacion += 1
        else:
            criterios['Longitud ‚â• 8 caracteres'] = False
        
        criterios['Contiene may√∫sculas'] = bool(re.search(r'[A-Z]', contrase√±a))
        if criterios['Contiene may√∫sculas']:
            puntuacion += 1
        
        criterios['Contiene min√∫sculas'] = bool(re.search(r'[a-z]', contrase√±a))
        if criterios['Contiene min√∫sculas']:
            puntuacion += 1
        
        criterios['Contiene n√∫meros'] = bool(re.search(r'\d', contrase√±a))
        if criterios['Contiene n√∫meros']:
            puntuacion += 1
        
        criterios['Contiene caracteres especiales'] = bool(re.search(r'[!@#$%^&*(),.?":{}|<>]', contrase√±a))
        if criterios['Contiene caracteres especiales']:
            puntuacion += 1
        
        criterios['Sin espacios'] = ' ' not in contrase√±a
        if criterios['Sin espacios']:
            puntuacion += 1
        
        print("Criterios cumplidos:")
        for criterio, cumplido in criterios.items():
            estado = "Valido" if cumplido else "Invalido"
            print(f"  {estado} {criterio}")
        
        if puntuacion >= 6:
            fortaleza = "MUY FUERTE"
        elif puntuacion >= 4:
            fortaleza = "FUERTE"
        elif puntuacion >= 3:
            fortaleza = "MEDIA"
        else:
            fortaleza = "D√âBIL"
        
        print(f"\nPuntuaci√≥n: {puntuacion}/7")
        print(f"Fortaleza: {fortaleza}")
        
        return puntuacion >= 4

def menu_principal():
    """
    Interfaz de usuario para el gestor de contrase√±as
    """
    gestor = GestorContrase√±as()
    
    while True:
        print("\n" + "="*50)
        print("          GESTOR DE CONTRASE√ëAS SEGURAS")
        print("="*50)
        print("1. Registrar nuevo usuario")
        print("2. Verificar contrase√±a")
        print("3. Generar contrase√±a segura")
        print("4. Evaluar fortaleza de contrase√±a")
        print("5. Mostrar usuarios")
        print("6. Mostrar alertas")
        print("7. Salir")
        print("-"*50)
        
        opcion = input("Selecciona una opci√≥n (1-7): ").strip()
        
        if opcion == "1":
            print("\n--- REGISTRAR USUARIO ---")
            usuario = input("Nombre de usuario: ").strip()
            contrase√±a = input("Contrase√±a: ").strip()
            gestor.registrar_usuario(usuario, contrase√±a)
        
        elif opcion == "2":
            print("\n--- VERIFICAR CONTRASE√ëA ---")
            usuario = input("Usuario: ").strip()
            contrase√±a = input("Contrase√±a: ").strip()
            gestor.verificar_contrase√±a(usuario, contrase√±a)
        
        elif opcion == "3":
            print("\n--- GENERAR CONTRASE√ëA SEGURA ---")
            try:
                longitud = int(input("Longitud de la contrase√±a (m√≠nimo 8): ") or "12")
                gestor.generar_contrase√±a_segura(longitud)
            except ValueError:
                print("Longitud inv√°lida. Usando longitud por defecto (12).")
                gestor.generar_contrase√±a_segura()
        
        elif opcion == "4":
            print("\n--- EVALUAR FORTALEZA DE CONTRASE√ëA ---")
            contrase√±a = input("Contrase√±a a evaluar: ").strip()
            gestor.evaluar_contrase√±a(contrase√±a)
        
        elif opcion == "5":
            gestor.mostrar_usuarios()
        
        elif opcion == "6":
            gestor.mostrar_alertas()
        
        elif opcion == "7":
            print("¬°Hasta pronto!")
            break
        
        else:
            print("Opci√≥n inv√°lida. Por favor, selecciona 1-7.")

if __name__ == "__main__":
    menu_principal()